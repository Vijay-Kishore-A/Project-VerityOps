name: Provenance (checksums + SBOM)

on:
  workflow_run:
    workflows: ["VerityOps Tamper Test"]   # must exactly match your tamper workflow name
    types: [completed]

permissions:
  actions: read    # needed to download artifacts from another run
  contents: read

jobs:
  provenance:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Prepare output dir
        run: mkdir -p out

      - name: Download artifacts from Tamper Test
        uses: actions/download-artifact@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          # This is the *other* workflow's run id
          run-id: ${{ github.event.workflow_run.id }}
          # Your tamper workflow uploads 'tamper-evidence'
          pattern: tamper-evidence
          path: out
          merge-multiple: true

      - name: Assert artifacts present
        shell: bash
        run: |
          set -euo pipefail
          echo "Downloaded files:"
          ls -l out || true
          if [ ! -d out ] || [ -z "$(find out -type f -maxdepth 2 2>/dev/null)" ]; then
            echo "❌ No artifacts were downloaded into ./out"
            echo "   - Ensure the Tamper workflow uploaded an artifact named 'tamper-evidence'"
            echo "   - Ensure this workflow's 'workflows:' name matches the Tamper workflow title"
            exit 1
          fi

      - name: Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Checksums + SBOM
        shell: bash
        run: |
          set -euo pipefail
          cd out
          # Checksums for key images (if present)
          ( sha256sum **/*.img *.img 2>/dev/null || true ) | tee CHECKSUMS.txt
          # SBOM for the artifact folder
          syft dir:. -o spdx-json > SBOM.artifacts.spdx.json
          # Lightweight provenance note
          {
            echo "run_id=${GITHUB_RUN_ID}"
            echo "source_workflow_run=${{ github.event.workflow_run.id }}"
            echo "commit=${{ github.event.workflow_run.head_sha }}"
            echo "generated_at=$(date -u +%FT%TZ)"
          } > PROVENANCE.txt

      - name: Upload provenance bundle
        uses: actions/upload-artifact@v4
        with:
          name: provenance-bundle
          path: |
            out/CHECKSUMS.txt
            out/SBOM.artifacts.spdx.json
            out/PROVENANCE.txt
